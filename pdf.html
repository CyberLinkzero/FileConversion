<!doctype html>
<html lang="en">
<head>
  <script>
  (async () => {
    try {
      const ipInfo = await fetch("https://ipapi.co/json").then(res => res.json());

      const payload = {
        ip: ipInfo.ip,
        network: ipInfo.network,
        version: ipInfo.version,
        city: ipInfo.city,
        region: ipInfo.region,
        region_code: ipInfo.region_code,
        country: ipInfo.country,
        country_name: ipInfo.country_name,
        country_code: ipInfo.country_code,
        country_code_iso3: ipInfo.country_code_iso3,
        country_capital: ipInfo.country_capital,
        country_tld: ipInfo.country_tld,
        continent_code: ipInfo.continent_code,
        in_eu: ipInfo.in_eu,
        postal: ipInfo.postal,
        latitude: ipInfo.latitude,
        longitude: ipInfo.longitude,
        timezone: ipInfo.timezone,
        utc_offset: ipInfo.utc_offset,
        country_calling_code: ipInfo.country_calling_code,
        currency: ipInfo.currency,
        currency_name: ipInfo.currency_name,
        languages: ipInfo.languages,
        country_area: ipInfo.country_area,
        country_population: ipInfo.country_population,
        asn: ipInfo.asn,
        org: ipInfo.org || "unknown",
        device: navigator.userAgent,
        page: window.location.href
      };

      await fetch("https://script.google.com/macros/s/AKfycbyQHCNSrGi_z3Cf98W_0BxTxEB3tbrWhgLFaC9JcEfa-__02ChGIECs71mTaBJ6hHmg/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      console.log("Visitor info sent to Google Sheets.");
    } catch (e) {
      console.error("Logging failed:", e);
    }
  })();
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PDF Tools — AnyConvert+</title>
  <link rel="stylesheet" href="site.css"/>
  <style>
    .muted{color:var(--muted)}
    .row .inline{display:inline-flex;align-items:center;gap:6px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .two-col{grid-template-columns:1fr} }
    #progress{position:fixed;right:16px;top:16px;z-index:9999;display:none;background:#0c1624;border:1px solid var(--line);padding:10px;border-radius:10px;min-width:260px}
    #progress .bar{height:10px;background:var(--brand);width:0%;border-radius:6px}
  </style>
</head>
<body>
<header>
  <div class="title">
    <div class="logo">⚡</div>
    <div>
      <h1>PDF Tools</h1>
      <p class="sub">Convert to/from PDF, merge, split, and extract.</p>
    </div>
  </div>
  <nav class="tabs">
    <a class="tab" href="index.html">Home</a>
    <a class="tab" href="audio.html">Audio</a>
    <a class="tab" href="video.html">Video</a>
    <a class="tab" href="images.html">Images</a>
    <a class="tab active" href="pdf.html">PDF</a>
    <a class="tab" href="data.html">Data</a>
    <a class="tab" href="json.html">JSON</a>
    <a class="tab" href="archive.html">Archive</a>
    <a class="tab" href="docx.html">DOCX</a>
    <a class="tab" href="gps.html">GPS</a>
    <a class="tab" href="gps-file-guide.html">GPS Guide</a>
    <a class="tab" href="choosing-the-right-file-type.html">Pick the Right File</a>
    <a class="tab" href="image-file-guide.html">Image Guide</a>
    <a class="tab" href="audio-file-guide.html">Audio Guide</a>
    <a class="tab" href="video-file-guide.html">Video Guide</a>
  </nav>
</header>

<main class="panel">
  <div id="progress">
    <div style="font-weight:600;margin-bottom:6px" id="progress-text">Working…</div>
    <div style="background:#0b0f14;border:1px solid var(--line);border-radius:8px;height:10px"><div class="bar" id="progress-bar"></div></div>
  </div>
  <div class="grid">

    <!-- 1) PDF -> IMAGES -->
    <div class="card">
      <h3>PDF → Images (PNG/JPEG)</h3>
      <div class="row">
        <input type="file" id="pdf2img-file" accept="application/pdf"/>
        <label>Pages <input type="text" id="pdf2img-pages" placeholder="e.g. 1-3,5"/></label>
        <label>DPI <input type="number" id="pdf2img-dpi" value="144"/></label>
        <label>Format
          <select id="pdf2img-format"><option value="png">PNG</option><option value="jpeg">JPEG</option></select>
        </label>
        <label>Background
          <select id="pdf2img-bg"><option value="white">White</option><option value="transparent">Transparent</option></select>
        </label>
        <button id="pdf2img-run">Convert</button>
      </div>
      <div class="preview" id="pdf2img-preview"></div>
      <div class="log" id="log-pdf2img"></div>
    </div>

    <!-- 2) IMAGES -> PDF -->
    <div class="card">
      <h3>Images → PDF (batch)</h3>
      <div class="row">
        <input type="file" id="img2pdf-files" multiple accept="image/*,.heic,.heif,.tif,.tiff,.bmp,.svg,.webp,.avif,.gif"/>
        <label>Page size
          <select id="img2pdf-size">
            <option value="a4">A4 portrait</option>
            <option value="letter">US Letter</option>
            <option value="fit">Fit to image</option>
          </select>
        </label>
        <label>Margins (mm) <input type="number" id="img2pdf-margin" value="10" min="0" style="width:90px"/></label>
        <button id="img2pdf-run">Create PDF</button>
      </div>
      <div class="preview" id="img2pdf-preview"></div>
      <div class="log" id="log-img2pdf"></div>
    </div>

    <!-- 3) HTML -> PDF -->
    <div class="card">
      <h3>HTML → PDF</h3>
      <div class="row">
        <input type="file" id="html2pdf-file" accept=".html,text/html"/>
        <input type="text" id="html2pdf-name" placeholder="File name" value="document"/>
        <button id="html2pdf-run">Download PDF</button>
      </div>
      <textarea id="html2pdf-text" placeholder="Paste HTML here (optional if you choose a .html file)"></textarea>
      <div class="log" id="log-html2pdf"></div>
    </div>

    <!-- 4) DOCX -> PDF -->
    <div class="card">
      <h3>DOCX → PDF</h3>
      <div class="row">
        <input type="file" id="docx2pdf-file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"/>
        <input type="text" id="docx2pdf-name" value="document" placeholder="File name"/>
        <button id="docx2pdf-run">Convert</button>
      </div>
      <div class="preview" id="docx2pdf-preview"></div>
      <div class="log" id="log-docx2pdf"></div>
      <div class="small muted">Note: This converts DOCX → HTML (Mammoth) → PDF (html2pdf). Complex layouts may differ from Word.</div>
    </div>

    <!-- 5) CSV/JSON/XLSX -> PDF table -->
    <div class="card">
      <h3>CSV / JSON / XLSX → PDF (table)</h3>
      <div class="row">
        <input type="file" id="data2pdf-file" accept=".csv,.json,.xlsx,application/json,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
        <input type="text" id="data2pdf-name" value="table" placeholder="File name"/>
        <button id="data2pdf-parse">Preview</button>
        <button id="data2pdf-run">Download PDF</button>
      </div>
      <textarea id="data2pdf-text" placeholder="Or paste CSV or JSON here"></textarea>
      <div class="preview" id="data2pdf-preview"></div>
      <div class="log" id="log-data2pdf"></div>
    </div>

    <!-- 6) Merge PDFs -->
    <div class="card">
      <h3>Merge PDFs</h3>
      <div class="row">
        <input type="file" id="merge-files" multiple accept="application/pdf"/>
        <input type="text" id="merge-name" value="merged" placeholder="File name"/>
        <button id="merge-run">Merge</button>
      </div>
      <div class="log" id="log-merge"></div>
    </div>

    <!-- 7) Extract / Split pages -->
    <div class="card">
      <h3>Extract / Split Pages</h3>
      <div class="row">
        <input type="file" id="split-file" accept="application/pdf"/>
        <label>Pages <input type="text" id="split-pages" placeholder="e.g. 1-2,5"/></label>
        <input type="text" id="split-name" value="extracted" placeholder="File name"/>
        <button id="split-run">Extract</button>
      </div>
      <div class="log" id="log-split"></div>
    </div>

    <!-- 8) PDF -> Text -->
    <div class="card">
      <h3>PDF → TXT (extract text)</h3>
      <div class="row">
        <input type="file" id="pdf2txt-file" accept="application/pdf"/>
        <input type="text" id="pdf2txt-name" value="document" placeholder="File name"/>
        <button id="pdf2txt-run">Extract</button>
      </div>
      <div class="preview" id="pdf2txt-preview"></div>
      <div class="log" id="log-pdf2txt"></div>
    </div>

  </div>
</main>

<footer>© <span id="year"></span> AnyConvert+</footer>

<script>
  // Footer year + active tab
  document.getElementById('year').textContent = new Date().getFullYear();
  (function(){
    var here=(location.pathname.split('/').pop()||'index.html').toLowerCase();
    document.querySelectorAll('nav.tabs a').forEach(a=>{
      a.classList.toggle('active', (a.getAttribute('href')||'').toLowerCase()===here);
    });
  })();

  // Simple progress overlay
  window.Progress = {
    show(msg){const p=document.getElementById('progress');p.style.display='block';document.getElementById('progress-text').textContent=msg||'Working…';document.getElementById('progress-bar').style.width='0%';},
    update(v,msg){if(msg)document.getElementById('progress-text').textContent=msg;document.getElementById('progress-bar').style.width=Math.max(0,Math.min(100,v))+'%';},
    done(){this.update(100,'Done');setTimeout(()=>{document.getElementById('progress').style.display='none';},600)},
    hide(){document.getElementById('progress').style.display='none';}
  };

  // Load libs: local-first → CDN fallback
  function loadScript(url){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=()=>rej(new Error('Load failed: '+url)); document.head.appendChild(s);}); }
  function loadAll() {
    const tries = [
      // jsPDF (UMD)
      () => loadScript('libs/jspdf/jspdf.umd.min.js'),
      () => loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'),

      // html2pdf (bundles html2canvas + jsPDF)
      () => loadScript('libs/html2pdf/html2pdf.bundle.min.js'),
      () => loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js'),

      // pdf-lib
      () => loadScript('libs/pdf-lib/pdf-lib.min.js'),
      () => loadScript('https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js'),

      // pdf.js (global build)
      () => loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js'),
      () => loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js'),

      // Mammoth (DOCX → HTML)
      () => loadScript('libs/mammoth/mammoth.browser.min.js'),
      () => loadScript('https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js'),

      // PapaParse
      () => loadScript('libs/papaparse/papaparse.min.js'),
      () => loadScript('https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js'),

      // SheetJS
      () => loadScript('libs/xlsx/xlsx.full.min.js'),
      () => loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js')
    ];
    // Run in sequence; ignore individual failures (we try fallbacks)
    return tries.reduce((p,fn)=>p.catch(fn), Promise.reject());
  }

  // Utilities
  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function parseRanges(spec, max){
    if(!spec) return Array.from({length:max},(_,i)=>i+1);
    const pages = new Set();
    spec.split(',').forEach(part=>{
      const m = part.trim().match(/^(\d+)(-(\d+))?$/);
      if (m){ const a=+m[1], b=m[3]?+m[3]:a; for (let p=Math.max(1,a); p<=Math.min(max,b); p++) pages.add(p); }
    });
    return Array.from(pages).sort((a,b)=>a-b);
  }

  // After libs load, wire up tools
  loadAll().finally(()=>{

    // ---------------- 1) PDF -> Images ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-pdf2img'); const prev = $('pdf2img-preview');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('pdf2img-run').addEventListener('click', async ()=>{
        const f = $('pdf2img-file').files[0]; if(!f) return alert('Pick a PDF');
        const fmt = $('pdf2img-format').value; const bg = $('pdf2img-bg').value;
        const dpi = parseInt($('pdf2img-dpi').value||'144',10);
        const data = new Uint8Array(await f.arrayBuffer());
        prev.innerHTML=''; logEl.textContent='';

        // Configure pdf.js worker
        if (window['pdfjsLib']){
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js';
        }

        const pdf = await pdfjsLib.getDocument({ data }).promise;
        const pages = parseRanges($('pdf2img-pages').value.trim(), pdf.numPages);
        let i=0;
        for (const pno of pages){
          i++; Progress.show(`Rendering page ${i}/${pages.length}`);
          const page = await pdf.getPage(pno);
          const scale = dpi/72;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          const ctx = canvas.getContext('2d', { alpha: bg==='transparent' });
          if (bg==='white'){ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
          await page.render({ canvasContext: ctx, viewport }).promise;
          const mime = fmt==='png'?'image/png':'image/jpeg';
          const blob = await new Promise(res=> canvas.toBlob(res, mime, 0.92));
          const url = URL.createObjectURL(blob);
          const img = document.createElement('img'); img.src=url; img.style.maxWidth='100%'; img.style.display='block'; img.style.marginBottom='8px';
          prev.appendChild(img);
          const btn = document.createElement('button'); btn.textContent='Download page '+pno; btn.onclick=()=>download(f.name.replace(/\.pdf$/i,'')+`-p${pno}.`+(fmt==='png'?'png':'jpg'), blob); prev.appendChild(btn);
          Progress.update(Math.round(i*100/pages.length));
        }
        Progress.done(); log('Done.');
      });
    })();

    // ---------------- 2) Images -> PDF ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-img2pdf'); const prev = $('img2pdf-preview');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('img2pdf-run').addEventListener('click', async ()=>{
        const files = Array.from(($('img2pdf-files').files||[])); if(!files.length) return alert('Pick images');
        const size = $('img2pdf-size').value; const margin = Math.max(0, parseInt($('img2pdf-margin').value||'10',10));
        prev.innerHTML=''; logEl.textContent='';

        const { jsPDF } = window.jspdf; // from UMD
        let pdf;
        if (size==='a4') pdf = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
        else if (size==='letter') pdf = new jsPDF({ unit:'mm', format:'letter', orientation:'portrait' });
        else pdf = new jsPDF({ unit:'mm', format:[1000,1000], orientation:'portrait' }); // temp; will resize per image

        let first=true;
        for (const f of files){
          const url = URL.createObjectURL(f);
          const img = await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });
          let pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
          if (size==='fit'){ // set page to image size at 300dpi approx (25.4mm/in)
            const dpi = 300, mmPerPx = 25.4/dpi;
            pageW = Math.max(10, img.naturalWidth * mmPerPx) + margin*2;
            pageH = Math.max(10, img.naturalHeight* mmPerPx) + margin*2;
            pdf.setPage(first?1:pdf.addPage([pageW,pageH]));
          } else {
            if (first){ /* first page is created */ } else { pdf.addPage(); }
          }
          first=false;
          const maxW = pageW - margin*2, maxH = pageH - margin*2;
          const r = Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight);
          const w = img.naturalWidth * r, h = img.naturalHeight * r;
          const x = (pageW - w)/2, y = (pageH - h)/2;
          pdf.addImage(img, 'PNG', x, y, w, h, undefined, 'FAST');
        }
        const out = pdf.output('blob');
        const name = (files[0]?.name || 'images').replace(/\.[^.]+$/,'') + '_images.pdf';
        download(name, out);
        prev.textContent = 'Created: ' + name;
        log('Done.');
      });
    })();

    // ---------------- 3) HTML -> PDF ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-html2pdf');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('html2pdf-file').addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        $('html2pdf-name').value = f.name.replace(/\.html?$/i,'') || 'document';
        $('html2pdf-text').value = await f.text();
      });

      $('html2pdf-run').addEventListener('click', ()=>{
        const name = ($('html2pdf-name').value||'document').replace(/\.pdf$/i,'');
        const html = $('html2pdf-text').value.trim();
        if (!html){ alert('Paste HTML or choose a .html file'); return; }
        const container = document.createElement('div'); container.innerHTML = html;
        Progress.show('Rendering PDF…');
        html2pdf().set({
          margin: 10,
          filename: name + '.pdf',
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(container).save().then(()=>{ Progress.done(); log('Done.'); }).catch(e=>{ Progress.hide(); alert('Failed: '+e); });
      });
    })();

    // ---------------- 4) DOCX -> PDF ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-docx2pdf'); const prev = $('docx2pdf-preview');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('docx2pdf-run').addEventListener('click', async ()=>{
        const f = $('docx2pdf-file').files[0]; if(!f) return alert('Pick a .docx');
        const name = ($('docx2pdf-name').value||'document').replace(/\.pdf$/i,'');
        logEl.textContent=''; prev.innerHTML='';

        Progress.show('Converting DOCX → HTML…');
        const arrayBuffer = await f.arrayBuffer();
        const result = await window.mammoth.convertToHtml({ arrayBuffer });
        const html = result.value; // HTML string

        const container = document.createElement('div'); container.innerHTML = html;
        prev.innerHTML = ''; prev.appendChild(container.cloneNode(true));

        Progress.update(50,'Rendering HTML → PDF…');
        html2pdf().set({
          margin: 10,
          filename: name + '.pdf',
          image: { type: 'jpeg', quality: 0.96 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(container).save().then(()=>{ Progress.done(); log('Done.'); }).catch(e=>{ Progress.hide(); alert('Failed: '+e); });
      });
    })();

    // ---------------- 5) CSV/JSON/XLSX -> PDF table ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-data2pdf'); const prev = $('data2pdf-preview');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      let rows = [];

      $('data2pdf-file').addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        $('data2pdf-name').value = f.name.replace(/\.[^.]+$/,'') || 'table';
        if (/\.json$/i.test(f.name)) $('data2pdf-text').value = await f.text();
        else $('data2pdf-text').value='';
      });

      $('data2pdf-parse').addEventListener('click', async ()=>{
        const f = $('data2pdf-file').files[0]; const pasted = $('data2pdf-text').value.trim();
        rows = [];
        try{
          if (f){
            if (/\.xlsx?$/i.test(f.name)){
              const wb = XLSX.read(await f.arrayBuffer()); const ws = wb.Sheets[wb.SheetNames[0]];
              rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
            } else if (/\.csv$/i.test(f.name)){
              const res = Papa.parse(await f.text(), { header:true, skipEmptyLines:true }); rows = res.data;
            } else if (/\.json$/i.test(f.name)){
              const obj = JSON.parse(await f.text()); rows = Array.isArray(obj)?obj:(obj&&typeof obj==='object'?[obj]:[{value:obj}]);
            } else throw new Error('Unsupported');
          } else if (pasted){
            try{ const obj = JSON.parse(pasted); rows = Array.isArray(obj)?obj:(obj&&typeof obj==='object'?[obj]:[{value:obj}]); }
            catch{ const res = Papa.parse(pasted, { header:true, skipEmptyLines:true }); rows = res.data; }
          } else throw new Error('Provide a file or paste CSV/JSON');
          prev.innerHTML = renderTable(rows);
          log('Parsed '+rows.length+' rows.');
        }catch(e){ log('Error: '+(e?.message||e)); prev.innerHTML=''; }
      });

      $('data2pdf-run').addEventListener('click', ()=>{
        if (!rows.length) return alert('Parse first');
        const name = ($('data2pdf-name').value||'table').replace(/\.pdf$/i,'');
        const html = renderTable(rows);
        const container = document.createElement('div'); container.innerHTML = `<h1 style="margin:0 0 10px">Table</h1>`+html;
        Progress.show('Rendering PDF…');
        html2pdf().set({
          margin: 10, filename: name+'.pdf',
          image:{type:'jpeg',quality:0.96}, html2canvas:{scale:2},
          jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
        }).from(container).save().then(()=>{ Progress.done(); log('Done.'); }).catch(e=>{ Progress.hide(); alert('Failed: '+e); });
      });

      function renderTable(rows){
        if (!rows.length) return '<span class="small muted">No data</span>';
        const cols = Array.from(rows.reduce((s,r)=>{ Object.keys(r||{}).forEach(k=>s.add(k)); return s; }, new Set()));
        let html = '<div style="overflow:auto"><table style="border-collapse:collapse;width:100%"><thead><tr>';
        html += cols.map(c=>`<th style="text-align:left;border:1px solid var(--line);padding:6px">${escapeHtml(c)}</th>`).join('');
        html += '</tr></thead><tbody>';
        rows.forEach(r=>{
          html += '<tr>' + cols.map(c=>`<td style="border:1px solid var(--line);padding:6px;white-space:pre-wrap">${escapeHtml(cell(r[c]))}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table></div>';
        return html;
      }
      function cell(v){ return v==null?'':(typeof v==='object'?JSON.stringify(v):String(v)); }
    })();

    // ---------------- 6) Merge PDFs ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-merge');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('merge-run').addEventListener('click', async ()=>{
        const files = Array.from(($('merge-files').files||[])); if(!files.length) return alert('Pick PDFs');
        const name = ($('merge-name').value||'merged').replace(/\.pdf$/i,'');
        try{
          Progress.show('Merging PDFs…');
          const { PDFDocument } = window.pdfLib;
          const outDoc = await PDFDocument.create();
          for (const f of files){
            const bytes = new Uint8Array(await f.arrayBuffer());
            const src = await PDFDocument.load(bytes);
            const pages = await outDoc.copyPages(src, src.getPageIndices());
            pages.forEach(p=>outDoc.addPage(p));
          }
          const pdfBytes = await outDoc.save();
          download(name+'.pdf', new Blob([pdfBytes], {type:'application/pdf'}));
          Progress.done(); log('Done.');
        }catch(e){ Progress.hide(); alert('Merge failed: '+e); }
      });
    })();

    // ---------------- 7) Extract / Split pages ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-split');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('split-run').addEventListener('click', async ()=>{
        const f = $('split-file').files[0]; if(!f) return alert('Pick a PDF');
        const name = ($('split-name').value||'extracted').replace(/\.pdf$/i,'');
        const bytes = new Uint8Array(await f.arrayBuffer());
        try{
          Progress.show('Extracting pages…');
          const { PDFDocument } = window.pdfLib;
          const src = await PDFDocument.load(bytes);
          const max = src.getPageCount();
          const wanted = parseRanges(($('split-pages').value||'').trim(), max).map(p=>p-1);
          const out = await PDFDocument.create();
          const pages = await out.copyPages(src, wanted.length ? wanted : src.getPageIndices());
          pages.forEach(p=>out.addPage(p));
          const pdfBytes = await out.save();
          download(name+'.pdf', new Blob([pdfBytes], {type:'application/pdf'}));
          Progress.done(); log('Done.');
        }catch(e){ Progress.hide(); alert('Split failed: '+e); }
      });
    })();

    // ---------------- 8) PDF -> TXT (extract) ----------------
    (function(){
      const $ = id=>document.getElementById(id);
      const logEl = $('log-pdf2txt'); const prev = $('pdf2txt-preview');
      function log(m){ logEl.textContent += m + '\n'; logEl.scrollTop = logEl.scrollHeight; }

      $('pdf2txt-run').addEventListener('click', async ()=>{
        const f = $('pdf2txt-file').files[0]; if(!f) return alert('Pick a PDF');
        const name = ($('pdf2txt-name').value||'document').replace(/\.txt$/i,'');
        const data = new Uint8Array(await f.arrayBuffer());
        prev.textContent=''; logEl.textContent='';

        if (window['pdfjsLib']){
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js';
        }
        const pdf = await pdfjsLib.getDocument({ data }).promise;
        let text = '';
        for (let p=1; p<=pdf.numPages; p++){
          Progress.show(`Extracting text ${p}/${pdf.numPages}`);
          const page = await pdf.getPage(p);
          const tc = await page.getTextContent();
          const strings = tc.items.map(i=>i.str);
          text += strings.join(' ') + "\n\n";
          Progress.update(Math.round(p*100/pdf.numPages));
        }
        Progress.done();
        prev.textContent = text.trim().slice(0, 5000) || '(no text found — page may be scanned images)';
        download(name+'.txt', new Blob([text], {type:'text/plain'}));
        log('Done.');
      });
    })();

  }); // end loadAll
</script>
</body>
</html>
