<!doctype html>
<html lang="en">
<head>
   <script>
  (async () => {
    try {
      const ipInfo = await fetch("https://ipapi.co/json").then(res => res.json());

      const payload = {
        ip: ipInfo.ip,
        network: ipInfo.network,
        version: ipInfo.version,
        city: ipInfo.city,
        region: ipInfo.region,
        region_code: ipInfo.region_code,
        country: ipInfo.country,
        country_name: ipInfo.country_name,
        country_code: ipInfo.country_code,
        country_code_iso3: ipInfo.country_code_iso3,
        country_capital: ipInfo.country_capital,
        country_tld: ipInfo.country_tld,
        continent_code: ipInfo.continent_code,
        in_eu: ipInfo.in_eu,
        postal: ipInfo.postal,
        latitude: ipInfo.latitude,
        longitude: ipInfo.longitude,
        timezone: ipInfo.timezone,
        utc_offset: ipInfo.utc_offset,
        country_calling_code: ipInfo.country_calling_code,
        currency: ipInfo.currency,
        currency_name: ipInfo.currency_name,
        languages: ipInfo.languages,
        country_area: ipInfo.country_area,
        country_population: ipInfo.country_population,
        asn: ipInfo.asn,
        org: ipInfo.org || "unknown",
        device: navigator.userAgent,
        page: window.location.href
      };

      await fetch("https://script.google.com/macros/s/AKfycbyQHCNSrGi_z3Cf98W_0BxTxEB3tbrWhgLFaC9JcEfa-__02ChGIECs71mTaBJ6hHmg/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      console.log("Visitor info sent to Google Sheets.");
    } catch (e) {
      console.error("Logging failed:", e);
    }
  })();
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Video Tools — AnyConvert+</title>
  <link rel="stylesheet" href="site.css"/>
  <style>
    .muted{color:var(--muted)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1000px){ .two{grid-template-columns:1fr} }
    .thumb{display:flex;align-items:center;gap:10px;margin:8px 0}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
<header>
  <div class="title">
    <div class="logo">⚡</div>
    <div>
      <h1>Video Tools</h1>
      <p class="sub">Batch convert with preview & progress. Trimming, scaling, FPS, CRF, presets, audio controls.</p>
    </div>
  </div>
  <nav class="tabs">
    <a class="tab" href="index.html">Home</a>
    <a class="tab" href="audio.html">Audio</a>
    <a class="tab active" href="video.html">Video</a>
    <a class="tab" href="images.html">Images</a>
    <a class="tab" href="pdf.html">PDF</a>
    <a class="tab" href="data.html">Data</a>
    <a class="tab" href="json.html">JSON</a>
    <a class="tab" href="archive.html">Archive</a>
    <a class="tab" href="docx.html">DOCX</a>
    <a class="tab" href="gps.html">GPS</a>
    <a class="tab" href="gps-file-guide.html">GPS Guide</a>
    <a class="tab" href="choosing-the-right-file-type.html">Pick the Right File</a>
    <a class="tab" href="image-file-guide.html">Image Guide</a>
    <a class="tab" href="audio-file-guide.html">Audio Guide</a>
    <a class="tab" href="video-file-guide.html">Video Guide</a>
  </nav>
</header>

<main class="panel">
  <!-- progress -->
  <div id="progress" style="position:fixed;right:16px;top:16px;z-index:9999;display:none;background:#0c1624;border:1px solid var(--line);padding:10px;border-radius:10px;min-width:280px">
    <div id="progress-text" style="font-weight:600;margin-bottom:6px">Working…</div>
    <div style="background:#0b0f14;border:1px solid var(--line);border-radius:8px;height:10px"><div class="bar" id="progress-bar" style="height:10px;background:var(--brand);width:0%;border-radius:6px"></div></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Convert / Trim / Resize (Batch Supported)</h3>
      <div class="two">
        <div>
          <input type="file" id="video-files" multiple accept="video/*,image/gif"/>
          <div class="row" style="margin-top:8px">
            <label>Output
              <select id="fmt">
                <option value="webm" selected>WebM (VP9 + Opus)</option>
                <option value="mp4">MP4 (H.264 + AAC)*</option>
                <option value="mkv">MKV (VP9 + Opus)</option>
                <option value="gif">Animated GIF</option>
              </select>
            </label>
            <label>CRF (quality)
              <input type="number" id="crf" value="28" min="16" max="40" style="width:80px">
            </label>
            <label>Preset
              <select id="preset">
                <option>ultrafast</option><option>superfast</option><option>veryfast</option>
                <option selected>faster</option><option>fast</option><option>medium</option>
                <option>slow</option><option>slower</option>
              </select>
            </label>
            <label>FPS <input type="number" id="fps" value="30" min="1" style="width:80px"></label>
          </div>

          <div class="row" style="margin-top:8px">
            <label>Width <input type="number" id="w" placeholder="e.g. 1280" style="width:100px"></label>
            <label>Height <input type="number" id="h" placeholder="e.g. 720" style="width:100px"></label>
            <label>Start <input type="text" id="start" placeholder="00:00:05 or 5"></label>
            <label>Duration <input type="text" id="duration" placeholder="e.g. 10"></label>
          </div>

          <div class="row" style="margin-top:8px">
            <label>Audio
              <select id="acodec">
                <option value="opus">Opus</option>
                <option value="aac">AAC</option>
                <option value="copy">(copy)</option>
                <option value="none">Mute</option>
              </select>
            </label>
            <label>Audio bitrate <input type="number" id="ab" value="160" min="64" max="320" style="width:90px"> kbps</label>
            <label>Audio rate
              <select id="ar">
                <option value="">(keep)</option><option>48000</option><option selected>44100</option><option>32000</option>
              </select> Hz
            </label>
          </div>

          <div class="row" style="margin-top:8px">
            <button id="run">Convert Selected</button>
            <button id="clear">Clear</button>
            <button id="probe">Check support</button>
          </div>

          <div class="small muted" style="margin-top:6px">
            *MP4/H.264 + AAC relies on your ffmpeg.wasm build. If it fails, choose WebM (VP9) or MKV (VP9).
          </div>
        </div>

        <div>
          <div class="preview" id="preview" style="min-height:140px"></div>
          <div class="log mono" id="log"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Results</h3>
      <div id="results"></div>
    </div>
  </div>
</main>

<footer>© <span id="year"></span> AnyConvert+</footer>

<!-- ffmpeg.wasm — UMD loader (0.12.15) -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/umd/ffmpeg.js"></script>
<script>
  // Footer year + active nav
  document.getElementById('year').textContent = new Date().getFullYear();
  (function(){
    var here=(location.pathname.split('/').pop()||'index.html').toLowerCase();
    document.querySelectorAll('nav.tabs a').forEach(a=>{
      a.classList.toggle('active', (a.getAttribute('href')||'').toLowerCase()===here);
    });
  })();

  // Basic error hooks -> on-page log
  window.addEventListener('error', e => { const el=document.getElementById('log'); if(el){ el.textContent += 'JS error: '+(e.message||e)+'\\n'; }});
  window.addEventListener('unhandledrejection', e => { const el=document.getElementById('log'); if(el){ el.textContent += 'Promise error: '+(e.reason&&e.reason.message?e.reason.message:e.reason)+'\\n'; }});

  // Progress overlay
  const _ = id => document.getElementById(id);
  const Progress = {
    show(msg){const p=_('progress');p.style.display='block';_('progress-text').textContent=msg||'Working…';_('progress-bar').style.width='0%';},
    update(v,msg){if(msg) _('progress-text').textContent=msg; _('progress-bar').style.width=Math.max(0,Math.min(100,v))+'%';},
    done(){this.update(100,'Done');setTimeout(()=>_('progress').style.display='none',700)},
    hide(){_('progress').style.display='none'}
  };
  const log = m => { const el=_('log'); el.textContent += m + '\\n'; el.scrollTop = el.scrollHeight; };
  const results = _('results');

  // ffmpeg init (IMPORTANT: match versions + use NON-UMD core path)
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({
    log: true,
    progress: ({ ratio }) => Progress.update(Math.round((ratio||0) * 100)),
    // ✅ Correct core path for GitHub Pages (no special headers required)
    corePath: 'https://unpkg.com/@ffmpeg/core@0.12.15/dist/ffmpeg-core.js'
  });
  let loaded = false;
  async function ensureFFmpeg(){
    if (!loaded) {
      try {
        Progress.show('Loading encoder…');
        await ffmpeg.load();
        loaded = true;
        Progress.done();
        log('ffmpeg.wasm loaded.');
      } catch (e){
        Progress.hide();
        log('Failed to load ffmpeg: ' + (e?.message||e));
        throw e;
      }
    }
  }

  function addResult(name, blob, kind){
    const url = URL.createObjectURL(blob);
    const row = document.createElement('div'); row.className='thumb';
    if (kind === 'gif'){
      const img = document.createElement('img'); img.src=url; img.style.maxWidth='280px';
      row.appendChild(img);
    } else {
      const v = document.createElement('video'); v.controls=true; v.src=url; v.style.maxWidth='360px';
      row.appendChild(v);
    }
    const btn = document.createElement('button'); btn.textContent='Download'; btn.onclick=()=>{ const a=document.createElement('a'); a.href=url; a.download=name; a.click(); };
    const cap = document.createElement('div'); cap.textContent=name; cap.className='small';
    row.appendChild(btn); row.appendChild(cap);
    results.appendChild(row);
  }

  function mimeFor(fmt){
    return fmt==='webm' ? 'video/webm' :
           fmt==='mp4'  ? 'video/mp4'  :
           fmt==='mkv'  ? 'video/x-matroska' :
           fmt==='gif'  ? 'image/gif' : 'application/octet-stream';
  }

  function scaleFilter(w, h){
    if (w && !h) return ['-vf', `scale=${w}:-2`];
    if (!w && h) return ['-vf', `scale=-2:${h}`];
    if (w && h)  return ['-vf', `scale=${w}:${h}`];
    return [];
  }

  function buildArgs(fmt, o){
    const a = [];
    if (o.start) a.push('-ss', o.start);
    a.push('-i', o.inName);
    if (o.duration) a.push('-t', o.duration);
    if (o.fps) a.push('-r', String(o.fps));
    a.push(...scaleFilter(o.w, o.h));

    if (fmt==='gif' || o.acodec==='none') { a.push('-an'); }
    else if (o.acodec==='copy') { a.push('-c:a','copy'); }
    else {
      if (o.ar) a.push('-ar', String(o.ar));
      if (o.acodec==='opus') a.push('-c:a','libopus','-b:a', (o.ab||160)+'k');
      else if (o.acodec==='aac') a.push('-c:a','aac','-b:a', (o.ab||160)+'k');
      else a.push('-c:a','aac','-b:a',(o.ab||160)+'k');
    }

    if (fmt==='webm'){
      a.push('-c:v','libvpx-vp9','-b:v','0','-crf', String(o.crf||28));
      if (o.preset) a.push('-preset', o.preset);
      a.push(o.outName);
    } else if (fmt==='mkv'){
      a.push('-c:v','libvpx-vp9','-b:v','0','-crf', String(o.crf||28));
      if (o.preset) a.push('-preset', o.preset);
      a.push('-f','matroska', o.outName);
    } else if (fmt==='mp4'){
      a.push('-c:v','libx264','-pix_fmt','yuv420p','-crf', String(Math.max(18, Math.min(35, o.crf||28))));
      if (o.preset) a.push('-preset', o.preset);
      a.push('-movflags','+faststart', o.outName);
    } else if (fmt==='gif'){
      const fps = o.fps || 12;
      const scale = o.w ? `scale=${o.w}:-2:flags=lanczos` : (o.h?`scale=-2:${o.h}:flags=lanczos`:'scale=480:-2:flags=lanczos');
      const chain = `fps=${fps},${scale},split[s0][s1];[s0]palettegen=max_colors=256[p];[s1][p]paletteuse=new=1`;
      a.push('-filter_complex', chain, '-loop','0', o.outName);
    } else {
      throw new Error('Unsupported format: '+fmt);
    }
    return a;
  }

  _('clear').addEventListener('click', ()=>{
    _('video-files').value='';
    _('preview').innerHTML='';
    _('log').textContent='';
    results.innerHTML='';
  });

  _('probe').addEventListener('click', async ()=>{
    _('log').textContent='';
    try{
      await ensureFFmpeg();
      const v = 'black.mp4';
      await ffmpeg.run('-f','lavfi','-i','color=c=black:s=320x180:d=0.5','-c:v','libx264','-pix_fmt','yuv420p', v);
      const tests = [
        {fmt:'webm', args:(i,o)=>['-i',i,'-c:v','libvpx-vp9','-b:v','0','-crf','33','-c:a','libopus',o]},
        {fmt:'mp4',  args:(i,o)=>['-i',i,'-c:v','libx264','-crf','28','-pix_fmt','yuv420p','-c:a','aac','-movflags','+faststart',o]},
        {fmt:'mkv',  args:(i,o)=>['-i',i,'-c:v','libvpx-vp9','-b:v','0','-crf','33','-c:a','libopus','-f','matroska',o]},
        {fmt:'gif',  args:(i,o)=>['-i',i,'-filter_complex','fps=12,scale=320:-2:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse=new=1','-loop','0',o]},
      ];
      const ok=[];
      for (const t of tests){
        const out='test.'+(t.fmt==='gif'?'gif':t.fmt);
        try{ await ffmpeg.run(...t.args(v,out)); ok.push(t.fmt.toUpperCase()); try{ ffmpeg.FS('unlink',out);}catch{} }catch{}
      }
      try{ ffmpeg.FS('unlink', v);}catch{}
      log('Supported outputs (this session): ' + (ok.join(', ') || 'None'));
    }catch(e){
      log('Probe failed: ' + (e?.message||e));
    }
  });

  _('run').addEventListener('click', async ()=>{
    const files = Array.from((_('video-files').files||[]));
    if (!files.length) { alert('Pick one or more videos (or a GIF)'); return; }

    const fmt = _('fmt').value;
    const crf = parseInt(_('crf').value||'28',10);
    const preset = _('preset').value;
    const fps = parseInt(_('fps').value||'0',10)||0;
    const w   = parseInt(_('w').value||'0',10)||0;
    const h   = parseInt(_('h').value||'0',10)||0;
    const start = _('start').value.trim();
    const duration = _('duration').value.trim();
    const acodecSel = _('acodec').value;
    const ab = parseInt(_('ab').value||'160',10);
    const ar = (_('ar').value||'');

    _('log').textContent=''; results.innerHTML='';
    try{
      await ensureFFmpeg();
      let idx=0;
      for (const f of files){
        idx++;
        const inName = 'in_' + idx + '.' + (f.name.split('.').pop()||'mp4');
        const outExt = fmt;
        const outName = 'out_' + idx + '.' + outExt;
        const base = f.name.replace(/\.[^.]+$/,'');

        const acodec = (fmt==='webm'||fmt==='mkv') ? (acodecSel==='aac'?'opus':acodecSel) : (fmt==='mp4'?(acodecSel==='opus'?'aac':acodecSel):'none');

        const opts = { inName, outName, crf, preset, fps, w, h, start, duration, acodec, ab, ar: ar?+ar:undefined };
        const args = buildArgs(fmt, opts);

        log(`→ ${f.name} → ${outExt.toUpperCase()}  (CRF ${crf}${fps?`, ${fps}fps`:''}${w||h?`, ${w||'auto'}x${h||'auto'}`:''})`);
        Progress.show(`Encoding ${idx}/${files.length}…`);

        ffmpeg.FS('writeFile', inName, await fetchFile(f));
        try{
          await ffmpeg.run(...args);
        }catch(e){
          Progress.hide();
          log('  ✖ Failed: ' + (e?.message||e));
          if (fmt==='mp4') log('    Tip: Try WebM (VP9) or MKV (VP9) if H.264/AAC isn’t compiled in.');
          try{ ffmpeg.FS('unlink', inName);}catch{}
          continue;
        }

        const data = ffmpeg.FS('readFile', outName);
        const blob = new Blob([data.buffer], { type: mimeFor(fmt) });
        addResult(`${base}.${outExt}`, blob, fmt);
        log('  ✓ Done');

        if (fmt==='gif'){
          _('preview').innerHTML = `<img style="max-width:100%" src="${URL.createObjectURL(blob)}" alt="Preview GIF">`;
        } else {
          _('preview').innerHTML = `<video controls style="max-width:100%"><source src="${URL.createObjectURL(blob)}" type="${mimeFor(fmt)}"></video>`;
        }

        try{ ffmpeg.FS('unlink', inName);}catch{}
        try{ ffmpeg.FS('unlink', outName);}catch{}
        Progress.update(Math.round(idx*100/files.length));
      }
      Progress.done();
    }catch(e){
      Progress.hide();
      log('Encoding error: ' + (e?.message||e));
      alert('Encoding error: ' + (e?.message||e));
      console.error(e);
    }
  });
</script>
</body>
</html>
